
%% bare_jrnl.tex
%% V1.2
%% 2002/11/18
%% by Michael Shell
%% mshell@ece.gatech.edu
%%
%% NOTE: This text file uses MS Windows line feed conventions. When (human)
%% reading this file on other platforms, you may have to use a text
%% editor that can handle lines terminated by the MS Windows line feed
%% characters (0x0D 0x0A).
%%
%% This is a skeleton file demonstrating the use of IEEEtran.cls
%% (requires IEEEtran.cls version 1.6b or later) with an IEEE journal paper.
%%
%% Support sites:
%% http://www.ieee.org
%% and/or
%% http://www.ctan.org/tex-archive/macros/latex/contrib/supported/IEEEtran/
%%
%% This code is offered as-is - no warranty - user assumes all risk.
%% Free to use, distribute and modify.

% *** Authors should verify (and, if needed, correct) their LaTeX system  ***
% *** with the testflow diagnostic prior to trusting their LaTeX platform ***
% *** with production work. IEEE's font choices can trigger bugs that do  ***
% *** not appear when using other class files.                            ***
% Testflow can be obtained at:
% http://www.ctan.org/tex-archive/macros/latex/contrib/supported/IEEEtran/testflow


% Note that the a4paper option is mainly intended so that authors in
% countries using A4 can easily print to A4 and see how their papers will
% look in print. Authors are encouraged to use U.S. letter paper when 
% submitting to IEEE. Use the testflow package mentioned above to verify
% correct handling of both paper sizes by the author's LaTeX system.
%
% Also note that the "draftcls" or "draftclsnofoot", not "draft", option
% should be used if it is desired that the figures are to be displayed in
% draft mode.
%
% This example can be formatted using the peerreview
% (instead of journal) mode.
\documentclass[journal]{IEEEtran}
% If the IEEEtran.cls has not been installed into the LaTeX system files,
% manually specify the path to it:
% \documentclass[journal]{../sty/IEEEtran}


% some very useful LaTeX packages include:

%\usepackage{cite}      % Written by Donald Arseneau
                        % V1.6 and later of IEEEtran pre-defines the format
                        % of the cite.sty package \cite{} output to follow
                        % that of IEEE. Loading the cite package will
                        % result in citation numbers being automatically
                        % sorted and properly "ranged". i.e.,
                        % [1], [9], [2], [7], [5], [6]
                        % (without using cite.sty)
                        % will become:
                        % [1], [2], [5]--[7], [9] (using cite.sty)
                        % cite.sty's \cite will automatically add leading
                        % space, if needed. Use cite.sty's noadjust option
                        % (cite.sty V3.8 and later) if you want to turn this
                        % off. cite.sty is already installed on most LaTeX
                        % systems. The latest version can be obtained at:
                        % http://www.ctan.org/tex-archive/macros/latex/contrib/supported/cite/

%\usepackage{graphicx}  % Written by David Carlisle and Sebastian Rahtz
                        % Required if you want graphics, photos, etc.
                        % graphicx.sty is already installed on most LaTeX
                        % systems. The latest version and documentation can
                        % be obtained at:
                        % http://www.ctan.org/tex-archive/macros/latex/required/graphics/
                        % Another good source of documentation is "Using
                        % Imported Graphics in LaTeX2e" by Keith Reckdahl
                        % which can be found as esplatex.ps and epslatex.pdf
                        % at: http://www.ctan.org/tex-archive/info/
% NOTE: for dual use with latex and pdflatex, instead load graphicx like:
%\ifx\pdfoutput\undefined
%\usepackage{graphicx}
%\else
%\usepackage[pdftex]{graphicx}
%\fi

% However, be warned that pdflatex will require graphics to be in PDF
% (not EPS) format and will preclude the use of PostScript based LaTeX
% packages such as psfrag.sty and pstricks.sty. IEEE conferences typically
% allow PDF graphics (and hence pdfLaTeX). However, IEEE journals do not
% (yet) allow image formats other than EPS or TIFF. Therefore, authors of
% journal papers should use traditional LaTeX with EPS graphics.
%
% The path(s) to the graphics files can also be declared: e.g.,
% \graphicspath{{../eps/}{../ps/}}
% if the graphics files are not located in the same directory as the
% .tex file. This can be done in each branch of the conditional above
% (after graphicx is loaded) to handle the EPS and PDF cases separately.
% In this way, full path information will not have to be specified in
% each \includegraphics command.
%
% Note that, when switching from latex to pdflatex and vice-versa, the new
% compiler will have to be run twice to clear some warnings.


%\usepackage{psfrag}    % Written by Craig Barratt, Michael C. Grant,
                        % and David Carlisle
                        % This package allows you to substitute LaTeX
                        % commands for text in imported EPS graphic files.
                        % In this way, LaTeX symbols can be placed into
                        % graphics that have been generated by other
                        % applications. You must use latex->dvips->ps2pdf
                        % workflow (not direct pdf output from pdflatex) if
                        % you wish to use this capability because it works
                        % via some PostScript tricks. Alternatively, the
                        % graphics could be processed as separate files via
                        % psfrag and dvips, then converted to PDF for
                        % inclusion in the main file which uses pdflatex.
                        % Docs are in "The PSfrag System" by Michael C. Grant
                        % and David Carlisle. There is also some information 
                        % about using psfrag in "Using Imported Graphics in
                        % LaTeX2e" by Keith Reckdahl which documents the
                        % graphicx package (see above). The psfrag package
                        % and documentation can be obtained at:
                        % http://www.ctan.org/tex-archive/macros/latex/contrib/supported/psfrag/

%\usepackage{subfigure} % Written by Steven Douglas Cochran
                        % This package makes it easy to put subfigures
                        % in your figures. i.e., "figure 1a and 1b"
                        % Docs are in "Using Imported Graphics in LaTeX2e"
                        % by Keith Reckdahl which also documents the graphicx
                        % package (see above). subfigure.sty is already
                        % installed on most LaTeX systems. The latest version
                        % and documentation can be obtained at:
                        % http://www.ctan.org/tex-archive/macros/latex/contrib/supported/subfigure/

%\usepackage{url}       % Written by Donald Arseneau
                        % Provides better support for handling and breaking
                        % URLs. url.sty is already installed on most LaTeX
                        % systems. The latest version can be obtained at:
                        % http://www.ctan.org/tex-archive/macros/latex/contrib/other/misc/
                        % Read the url.sty source comments for usage information.

%\usepackage{stfloats}  % Written by Sigitas Tolusis
                        % Gives LaTeX2e the ability to do double column
                        % floats at the bottom of the page as well as the top.
                        % (e.g., "\begin{figure*}[!b]" is not normally
                        % possible in LaTeX2e). This is an invasive package
                        % which rewrites many portions of the LaTeX2e output
                        % routines. It may not work with other packages that
                        % modify the LaTeX2e output routine and/or with other
                        % versions of LaTeX. The latest version and
                        % documentation can be obtained at:
                        % http://www.ctan.org/tex-archive/macros/latex/contrib/supported/sttools/
                        % Documentation is contained in the stfloats.sty
                        % comments as well as in the presfull.pdf file.
                        % Do not use the stfloats baselinefloat ability as
                        % IEEE does not allow \baselineskip to stretch.
                        % Authors submitting work to the IEEE should note
                        % that IEEE rarely uses double column equations and
                        % that authors should try to avoid such use.
                        % Do not be tempted to use the cuted.sty or
                        % midfloat.sty package (by the same author) as IEEE
                        % does not format its papers in such ways.

%\usepackage{amsmath}   % From the American Mathematical Society
                        % A popular package that provides many helpful commands
                        % for dealing with mathematics. Note that the AMSmath
                        % package sets \interdisplaylinepenalty to 10000 thus
                        % preventing page breaks from occurring within multiline
                        % equations. Use:
%\interdisplaylinepenalty=2500
                        % after loading amsmath to restore such page breaks
                        % as IEEEtran.cls normally does. amsmath.sty is already
                        % installed on most LaTeX systems. The latest version
                        % and documentation can be obtained at:
                        % http://www.ctan.org/tex-archive/macros/latex/required/amslatex/math/



% Other popular packages for formatting tables and equations include:

%\usepackage{array}
% Frank Mittelbach's and David Carlisle's array.sty which improves the
% LaTeX2e array and tabular environments to provide better appearances and
% additional user controls. array.sty is already installed on most systems.
% The latest version and documentation can be obtained at:
% http://www.ctan.org/tex-archive/macros/latex/required/tools/

% Mark Wooding's extremely powerful MDW tools, especially mdwmath.sty and
% mdwtab.sty which are used to format equations and tables, respectively.
% The MDWtools set is already installed on most LaTeX systems. The lastest
% version and documentation is available at:
% http://www.ctan.org/tex-archive/macros/latex/contrib/supported/mdwtools/


% V1.6 of IEEEtran contains the IEEEeqnarray family of commands that can
% be used to generate multiline equations as well as matrices, tables, etc.


% Also of notable interest:

% Scott Pakin's eqparbox package for creating (automatically sized) equal
% width boxes. Available:
% http://www.ctan.org/tex-archive/macros/latex/contrib/supported/eqparbox/



% Notes on hyperref:
% IEEEtran.cls attempts to be compliant with the hyperref package, written
% by Heiko Oberdiek and Sebastian Rahtz, which provides hyperlinks within
% a document as well as an index for PDF files (produced via pdflatex).
% However, it is a tad difficult to properly interface LaTeX classes and
% packages with this (necessarily) complex and invasive package. It is
% recommended that hyperref not be used for work that is to be submitted
% to the IEEE. Users who wish to use hyperref *must* ensure that their
% hyperref version is 6.72u or later *and* IEEEtran.cls is version 1.6b
% or later. The latest version of hyperref can be obtained at:
%
% http://www.ctan.org/tex-archive/macros/latex/contrib/supported/hyperref/
%
% Also, be aware that cite.sty (as of version 3.9, 11/2001) and hyperref.sty
% (as of version 6.72t, 2002/07/25) do not work optimally together.
% To mediate the differences between these two packages, IEEEtran.cls, as
% of v1.6b, predefines a command that fools hyperref into thinking that
% the natbib package is being used - causing it not to modify the existing
% citation commands, and allowing cite.sty to operate as normal. However,
% as a result, citation numbers will not be hyperlinked. Another side effect
% of this approach is that the natbib.sty package will not properly load
% under IEEEtran.cls. However, current versions of natbib are not capable
% of compressing and sorting citation numbers in IEEE's style - so this
% should not be an issue. If, for some strange reason, the user wants to
% load natbib.sty under IEEEtran.cls, the following code must be placed
% before natbib.sty can be loaded:
%
% \makeatletter
% \let\NAT@parse\undefined
% \makeatother
%
% Hyperref should be loaded differently depending on whether pdflatex
% or traditional latex is being used:
%
%\ifx\pdfoutput\undefined
%\usepackage[hypertex]{hyperref}
%\else
%\usepackage[pdftex,hypertexnames=false]{hyperref}
%\fi
%
% Pdflatex produces superior hyperref results and is the recommended
% compiler for such use.



% *** Do not adjust lengths that control margins, column widths, etc. ***
% *** Do not use packages that alter fonts (such as pslatex).         ***
% There should be no need to do such things with IEEEtran.cls V1.6 and later.


% correct bad hyphenation here
\hyphenation{op-tical net-works semi-conduc-tor}


\begin{document}
%
% paper title
\title{Grayscale image segmentation using reversible jump MCMC.}
%
%
% author names and IEEE memberships
% note positions of commas and nonbreaking spaces ( ~ ) LaTeX will not break
% a structure at a ~ so this keeps an author's name from being broken across
% two lines.
% use \thanks{} to gain access to the first footnote area
% a separate \thanks must be used for each paragraph as LaTeX2e's \thanks
% was not built to handle multiple paragraphs
\author{Pavel V. Senin,
			  ~\IEEEmembership{UH,~Student}% <-this % stops a space
\thanks{The work was not supported by the IEEE.}% <-this % stops a space
\thanks{Last revised at \date{\today}.}% <-this % stops a space
\thanks{Thanks to my kids for constant disturbing.}}
% note the % following the last \IEEEmembership and also the first \thanks - 
% these prevent an unwanted space from occurring between the last author name
% and the end of the author line. i.e., if you had this:
% 
% \author{....lastname \thanks{...} \thanks{...} }
%                     ^------------^------------^----Do not want these spaces!
%
% a space would be appended to the last name and could cause every name on that
% line to be shifted left slightly. This is one of those "LaTeX things". For
% instance, "A\textbf{} \textbf{}B" will typeset as "A B" not "AB". If you want
% "AB" then you have to do: "A\textbf{}\textbf{}B"
% \thanks is no different in this regard, so shield the last } of each \thanks
% that ends a line with a % and do not let a space in before the next \thanks.
% Spaces after \IEEEmembership other than the last one are OK (and needed) as
% you are supposed to have spaces between the names. For what it is worth,
% this is a minor point as most people would not even notice if the said evil
% space somehow managed to creep in.
%
% The paper headers
\markboth{Final report, ~ICS663 ~non-classified ~files ~FALL 2006, ~Vol.~1, \date{\today}}{Shell \MakeLowercase{\textit{et al.}}: Very first draft.}
% The only time the second header will appear is for the odd numbered pages
% after the title page when using the twoside option.
% 
% *** Note that you probably will NOT want to include the author's name in ***
% *** the headers of peer review papers.                                   ***

% If you want to put a publisher's ID mark on the page
% (can leave text blank if you just want to see how the
% text height on the first page will be reduced by IEEE)
%\pubid{0000--0000/00\$00.00~\copyright~2002 IEEE}

% use only for invited papers
%\specialpapernotice{(Invited Paper)}

% make the title area
\maketitle


\begin{abstract}
While the ultimate goal of this project was to build an Reversible Jump MCMC sampler for image segmentation the others methods such as ICM, Gibbs sampler, Metropolis sampler and Simulated Annealing are nesessary milestones in order to meet the goal. So far all milestones are implemented while RJMCMC sampler itself is not done - the acceptance of the split or joining of classes are not finished. Being crucial in RJMCMC method, this part prevents from sucsessfull project closure. Nevertheless author believs that it could and would be done in short time after 5th of December of 2006. If not the idea could be picked by anyone interested in this stuff.
\end{abstract}

\begin{keywords}
RJMCMC, image segmentation, Gibbs sampler, ICM, Metropolis sampler.
\end{keywords}
% Note that keywords are not normally used for peerreview papers.

% For peer review papers, you can put extra information on the cover
% page as needed:
% \begin{center} \bfseries EDICS Category: 3-BBND \end{center}
%
% For peerreview papers, inserts a page break and creates the second title.
% Will be ignored for other modes.
\IEEEpeerreviewmaketitle


\section{Model design}
\subsection{Introduction}
\PARstart{I}{n} the core of this work lies publication [1] by Zoltan Kato "Bayesian Color image segmentation using reversible jump Markov Chain Monte-Carlo". Method described by author deals with the problem of unsupervised image segmentation. It means that it should accept an image as the only input paramether and produce a segmented image representation as output. The metod itsel relies on the use of a firs-order Markov Field (MRF, Plotts model) and employs ICM algorithm [2], Gibbs sampler [3], and Metropolis sampler[4] along with optimization criteria based on Simulated annealing algorithm.

As I already written in the project proposal and intermediate roport, the image segmentation is one of the fundamental problems in computer vision and lies an the first-row low-level tasks for full image processing like surface description, object recognition, content bases indexing stc. 

I believe that Reversible Jump mimics ntural human ability to segment images that are noizy or have very little features to do segmentation exactly. Basically this method search within the multidimentional variants space trying to maximize classes separation. The approach itself seems to be havyweight and computationally costly, but second reason to choose this way is my own interest in understanding of unsupervised learning and ICA. 

At the beginning I was considering R (or 'GNU S'), a freely available language and environment for statistical computing and graphics as the programming environment. The taken choice was errorneous, despite well supported and having numerous libraries for image IO and raster manipulations, the R itself is extremely slow in matrix processing and has certain limitations in software design due to namespace, plain code execution and lack of debugger along with IDE development. The lesson learned from this try is that while R is the ultimate "statistic" calculator (due to numerous packages) along with great plotting capabilities, it is more apropriate for single task solving, not for the routine program development, debug and refactoring of the code.

My second choice was Java and so far it provides desired functionality and flexibility. The software that done for the project is perfectly working, and could be easily dbugged and extended in any desired way.

\subsection{Model design}
The observed image is: $\textsl{F} = \left\{ \vec{f}_{s} \left| s \in \textsl{S}, \forall i : 0 < \vec{f}^{i}_{s} < 1 \right. \right\}$,
where vector $\vec{f}_{s}$ is vector that carried intensity of colour for pixel s. The segmentation itself is just labeling of each pixel $s \in S$ by label $\omega_{s} \in \Lambda = \left\{ 1,2,...,L \right\}$. $\omega\in\Omega$ denotes a labeling (or segmentation), $\Omega$ is a set of all possible labeling.

We regard our image as a sample drawn from unknown Gaussian mixture distribution. The goal of our analysis is inference about the number 
$L$ components:

- the component parameter 

\begin{flushright}
$\Theta = \left\{\forall\lambda : 1\leq \lambda \leq \textsl{L}, \Theta_{\lambda}=\left(\vec{\mu_{\lambda}},\Sigma_{\lambda} \right) \right\};$
\end{flushright}

- the component weights $\textsl p_{\lambda}\left(1\leq\lambda\leq \textsl L \right)$ summing to 1;

- the clique potential (or inter-pixel interaction strength), $\beta$;
 
- the segmentation $\omega$.

The joint distribution of above variables $L,p,\beta,\omega,\Theta,F$ given by formula :
\begin{equation}
P\left(L,p,\beta,\omega,\Theta,F\right) = P\left(\omega,F\left|\Theta,\beta,p,L\right.\right)P\left(\Theta,\beta,p,L\right)
\end{equation}
Impose the independence of labeling $\Theta$, inter-pixel composition $\beta$, component weights $p$, and labels set power $L$ as parameters that given randomly in every processed image. Therefore their joint probability reduces to 
\begin{equation}
P\left(\Theta,\beta,p,L\right) = P\left(\Theta\right)P\left(\beta\right)P\left(p\right)P\left(L\right)
\end{equation}
The posterior distribution of $\left(F, \omega \right)$ may be expressed as:
\begin{equation}
P\left(F,\omega\left|\right.\Theta,\beta,p,L\right)=P\left(F\left|\right.\omega,\Theta,\beta,p,L\right)P\left(\omega\left|\right.\Theta,\beta,p,L\right)
\end{equation}
The pixel classes (segmentation itself) represented as a multivariate Gaussian distribution and the underlied MRF (Markov Random Field) process follows a Gibbs distribution defined over a first order neighborhood system. 

Previous equation could be factored out as:
\begin{equation}
\left(F\left|\right.\omega,\Theta,\beta,p,L\right) = 
P\left(F\left|\right.\omega,\Theta\right)=$$
\par
$\prod_{s \in S}
\left(\frac{1}{\sqrt{\left(2\pi\right)^{3}\left|\sum_{\omega_{s}}\right|}}
\exp\left(
-\frac{1}{2}
\left(\vec{f}_{s}-\vec{\mu}_{\omega_{s}}\right) \right.\times $$
\par
$\left.\left.\sum_{\omega_{s}}^{-1}
\left(\vec{f}_{s}-\vec{\mu}_{\omega_{s}}\right)^T \right)\right)
\end{equation}

Proceeding further we have:
\begin{equation}
P\left(\omega\left|\right.\Theta,\beta,p,L\right) = 
P\left(\omega\left|\right.\beta,p,L\right) = $$
\par
$\frac {1} {Z\left(\beta,p,L\right)}
\exp\left(
-U\left(\omega\left|\right.\beta p,L\right)
\right)
\end{equation}
$$

where $U\left(\omega\left|\right.\beta, p, L \right)$ is energy function:

\begin{equation}
U\left(\omega\left|\right.\beta, p,L\right) = 
\sum_{s\in S}-\log\left(p_{\omega_{s}}\right) +
\beta\sum_{\left\{s,r\right\}\in C}
\delta\left(\omega_{s},\omega_{r}\right)
\end{equation}
$\delta\left(\omega_{s},\omega_{r}\right) = 1$ if $\omega_{s}$ and $\omega_{r}$ are different and -1 otherwise. 
$Z\left(\beta,p,L\right) = \sum_{\omega\in \Omega}\exp\left( -U\left(\omega\left|\right.\beta,p,L\right)\right)$ is normalization constant or partition function. $C$ denotes the set of cliques and $\left\{s,r\right\}$ is doubleton containing the neighboring pixel sites $r$ and $s$.

Note that the whole posterior distribution could be derived from Gibbs distribution where the Gaussian distribution taken in account in the energy of the external field:
\begin{equation}
U\left(F\left|\right.\omega,\Theta\right) = 
-\log\left(P\left(F\left|\right.\omega,\Theta\right)\right) = 

\sum\limits_{s\in S}\left(
\ln\left(\sqrt{\left(2\pi\right)^{3}}\right) +
\frac{1}{2}
\left(\vec{f}_{s}-\vec{\mu}_{\omega_{s}}\right)
\sum_{\omega_{s}}^{-1}
\left(\vec{f}_{s}-\vec{\mu}_{\omega_{s}}\right)^T
\right)
\end{equation}

Now, we are using facts that $P\left(F\right)$ is constant for any particular image and Equation (1), Equation (2), Equation (4) and Equation (7) we are able to approximate the posterior density $P\left(L,p,\beta,\omega,\Theta\left|\right.F\right) = P\left(L,p,\beta,\omega,\Theta,F\right)/P\left(F\right)$:
\begin{equation}
P\left(L,p,\beta,\omega,\Theta\left|\right.F\right) = $$
\par
$P\left(F\left|\right.\omega\Theta\right)
P\left(\omega\left|\right.\beta,p,L\right)
P\left(\Theta\right)P\left(\beta\right)P\left(p\right)P\left(L\right)$$
\par
$\approx
\prod\limits_{s \in S}
\left(
\frac{1}
{\sqrt{\left(2\pi\right)^{3}\left|\sum_{\omega_{s}}\right|}}
\exp\left(
-\frac{1}{2}
\left(\vec{f}_{s}-\vec{\mu}_{\omega_{s}}\right)\right.\right. \times $$
\par
$\left.\left.\sum_{\omega_{s}}^{-1}
\left(\vec{f}_{s}-\vec{\mu}_{\omega_{s}}\right)^T\right)\right) \times $$
\par
$\prod\limits_{s\in S}
\frac{
p_{\omega_{s}}
\exp\left(
-\beta 
\sum_{\forall r : \left\{s,r\right\} \in C } \delta\left(\omega_{s},\omega_{r}\right)
\right)
}
{
\sum_{\lambda\in\Lambda}p_{\lambda}
\exp\left(
-\beta
\sum_{\forall r : \left\{s,r\right\} \in C } \delta\left(\lambda,\omega_{r}\right)
\right)
}

\times P\left(\beta\right)P\left(L\right)
\prod\limits_{\lambda\in\Lambda}
P\left(\vec{\mu_{\lambda}}\right)P\left(\Sigma_{\lambda}\right)P\left(p_{\lambda}\right)
\end{equation}

Concerning the priors, this model choose uniform reference priors for $L$, $\vec{\mu_{\lambda}}$, $\Sigma_{\lambda}$, $p_{\lambda}$ where $\lambda \in \Lambda$.

\subsection{Sampling from Posterior}
Herein we will construct MCMC sampler from posterior distribution which is used in equation (8) for our segmentation model. Classical MCMC cannot be used, because of changing dimensionality of the parameter space. Reversible Jump MCMC however capable to hold this issue [5]. Our set of unknowns is $\left\{L,p,\beta,\omega,\Theta\right\}$, lets denote it as $X$ and let $\pi\left(X\right)$ be the target probability measure (the posterior distribution). The wildly used tool to sample from such distribution is Metropolis-Hasting method [3, 4]. When the current state is $X$ the new state is drawn from an arbitrary joint distribution $q\left(X,X'\right)$. The new state is accepted with probability 
\begin{equation}
A(X,X') = \min\left(1,
\frac{\pi\left(X'\right)q\left(X,X'\right)}
{\pi\left(X\right)q\left(X',X\right)}\right)
\end{equation}
We have multiple parameter subspaces of different dimensionality and it is nessesary to devise move types between subspaces (CITATION?). These moves will be combined in so called hybrid sampler (CITATION?) by random choice between available moves at each transition. We denote the moves as $m \in M = \left\{1,2,...,M\right\}$ and let $q\left(X,X'\right)$ be the probability of proposing the move type $m$ and state $X'$ when the current state is $X$. Not all move types available from the beginning, so for some certain $X, q_{m}\left(X,\cdot\right)$ might be $0$ for some $m$. Furthermore $ q_{m}\left(X,\cdot\right)$ is is a sub-probability measure on $m$ at $X'$ and $\sum\limits_{m \in M} q_{m}\left(X,\cdot\right) \leq 1$ (CITATION ORIGINAL RJ PAPER). The proposed state is than accepted with probability 
\begin{equation}
A_{m}(X,X') = \min\left(1,
\frac{\pi\left(X'\right)q_{m}\left(X,X'\right)}
{\pi\left(X\right)q_{m}\left(X',X\right)}\right)
\end{equation}

NEED TO PUT MORE JUSTIFICATION AND EXPLANATION HERE.

\subsection{Hybrid Sampler}
For sketched in previous section model we need to work out sampler. It will consist of five moves:

1. Sampling the class labels $\omega$, i.e. resegment the image;

2. Sampling Gaussian parameters $\Theta=\left\{\left(\vec_{\mu_{\lambda},\Sigma_{\lambda}\right)\left|\right.\lambda\in\Lambda\right\}$;

3. Sampling the mixture weights $p_{\lambda}\left(\lambda\in\Lambda\right)$;

4. Sampling the MRF hyperparameter \beta;

5. sampling the number of classes $L$, i.e. splitting one of mixture components into two or merge two of them into one.

Cases 1 - 4 are not random instead of case 5 where at each sweep we decide randomly about splitting or combining.

\subsection{Move 1 - image segmentation}
This move is just classical image segmentation with known parameters, i.e. we have fixed parameters - their estimates, 

\begin{equation}
P\left(L,p,\beta,\omega,\Theta\left|\right.F\right) \approx 
P\left(F\left|\right.\omega,\widehat{\Theta}\right)
P\left(\omega\left|\right.\widehat{\beta},\widehat{p},\widehat{L}\right)
P\left(\Theta\right)P\left(\beta\right)P\left(p\right)P\left(L\right)

\approx
\prod\limits_{s \in S}
\left(
\frac{1}
{\sqrt{\left(2\pi\right)^{3}\left|\widehat{\Sigma}_{\omega_{s}}\right|}}
\exp\left(
-\frac{1}{2}
\left(\vec{f}_{s}-\vec{\widehat{\mu}}_{\omega_{s}}\right)
\widehat{\Sigma}_{\omega_{s}}^{-1}
\left(\vec{f}_{s}-\vec{\widehat{\mu}}_{\omega_{s}}\right)^T
\right)
\right)

\times
\prod\limits_{s\in S}
\widehat{p}_{\omega_{s}}
\exp\left(
-\widehat{\beta} 
\sum\limits_{\forall r : \left\{s,r\right\} \in C } \delta\left(\omega_{s},\omega_{r}\right)
\right)
\end{equation}

We have eliminated $Z\left(\beta,p,L\right) = Z\left(\widehat{\beta},\widehat{p},\widehat{L}\right)$ because it is constant for the $\Omega$. Furthermore sub-chain could be sampled using Gibbs sampler since $\omega$ takes discrete values over finite set $\Lambda$.

\subsection{Move 2 - estimating Gaussian parameters}
This move is aiming mean and covariance matrix of the pixel classes. By setting variables $L,p,\beta,\omega$ to their estimates $\widehat{L},\widehat{p},\widehat{\beta},\widehat{\omega}$ Equation (9) reduces to the form:
\begin{equation}
P\left(L,p,\beta,\omega,\Theta\left|\right.F\right) \approx 
P\left(F,\widehat{\omega}\left|\right.\Theta\right)P\left(\Theta\right) = 

\prod\limits_{\lambda \in \Lambda}{
\prod\limits_{s:\widehat{\omega}_{s}=\lambda}{
P\left(\vec{f}_{s}\right|\left.\vec{\mu}_{\lambda},\Sigma_{lambda}\right)
P\left(\vec{\mu}_{\lambda}\right)P\left(\Sigma_{\lambda}\right) = 

\times
\prod\limits_{s\in S}
\frac{1}
{\left(\left(2\pi\right)^{3}
\left|\Sigma_{\lambda}\right|\right)^{\left|\Sigma_{\lambda}\right|/2}
}
\exp{
\left(
-\frac{1}{2}
\sum\limits_{s:\widehat{\omega}_{s}=\lambda}\left(\vec{f}_{s}-\vec{\mu}_{\lambda}\right)
\Sigma_{\lambda}^{-1}\left(\vec{f}_{s}-\vec{\mu}_{\lambda}\right)^{T}
\right)
}

\times
\prod\limits_{\lambda\in\Lambda}{
P\left(\vec{\mu}_{\lambda}\right)P\left(\Sigma_{\lambda}\right)P\left(p_{\lambda}\right)
}
\end{equation}
where $\left|\Sigma_{\lambda}\right|$ is number of sites labeled by $\lambda$.

\subsection{Move 3 - sampling Mixture Weights}
<not filled yet>
\subsection{Move 4 - sampling Hyperparameter \beta}
<not filled yet>
\section{Move 5 - Estimating number of classes}
<not filled yet>
\subsection{Sampling distribution}
<not filled yet>
\subsection{Splitting classes (generating new parameters and reallocating labels)}
<not filled yet>
\subsection{Merging classes (generating new parameters and reallocating labels)}
<not filled yet>
\subsection{Move acceptance probability}

\section{Optimization according to the MAP criteria, Simulated annealing}
This section contains description of MAP estimator that provides us with an image segmentation$\widehat{\omega}$ and model parameters $\widehat{L},\widehat{p},\widehat{\beta},\widehat{\Theta}$. The estimation is done via stochastic relaxation algorithm. The MAP estimator is given by:
\begin{equation}
\left(\widehat{\omega},\widehat{L},\widehat{p},\widehat{\beta},\widehat{\Theta}\right)^{\left(MAP\right)} = 
\arg \max\limits_{L,p,\beta,\omega,\Theta}P\left(L,p,\beta,\omega,\Theta\left|\right.F\right) 
\end{equation}
with the following constaraints:
\begin{equation}
\omega \in \Omega,
\end{equation}
\begin{equation}
L_{min} \leq L \leq L_{max},
\end{equation}
\begin{equation}
\sum\limits_{\lambda\in\Lambda}p_{lambda} = 1,
\end{equation}
\begin{equation}
\forall\labda\in\Lambda : 0 \leq \mu_{\labda,i} \leq 1,
\end{equation}
\begin{equation}
\forall\labda\in\Lambda : 0 \leq \Sigma_{\labda,i,i} \leq 1, -1 \leq \Sigma_{\labda,i,j} \leq 1
\end{equation}
First equation of this section itself is a combinatorial optimization problem which requires special algorithms such as simulated annealing (CITATION NEEDED). In our case this process could be formulated as follows:

\section{Algorithm, RJMCMC segmentation}

1. Set $k=0$ and initialize $\widehat{L}^{0},\widehat{p}^{0},\widehat{\beta}^{0},\widehat{\Theta}^{0}$, and set temperature $\tau^{0}$.

2. A sample $\left(\widehat{\omega}^{k},\widehat{L}^{k},\widehat{p}^{k},\widehat{\beta}^{k},\widehat{\Theta}^{k}\right)$ is drawn from the modified posterior distribution using the hybrid sampler defined in section (NUMBER NEEDED) before. The modification is due to simulated annealing constaraint - temperature $\tau_{k}$:
\begin{equation}
\prod\limits_{s\in S}
\frac{1}
{\left(\left(2\pi\right)^{3}
\left|\Sigma_{\omega_{s}}\right|\right)^{1/2\tau_{k}}
}
\exp{
\left(
-\frac{1}{2\tau_{k}}
\left(\vec{f}_{s}-\vec{\mu}_{\omega_{s}}\right)
\Sigma_{\omega_{s}}^{-1}\left(\vec{f}_{s}-\vec{\mu}_{\omega_{s}}\right)^{T}
\right)

\times
\prod\limits_{s\in S}\frac
{\exp\left(\frac{\log\left(p_{\omega_{s}}\right)}{\tau_{k}}
-\frac{\beta}{\tau_{k}}\sum\limits_{\forall r : \left\{s,r\right\}\in C}\delta\left(\omega_{s},\omega_{r}\right)\right)}
{
\sum\limits_{\lambda\in\Lambda}
\exp\left(\frac{\log\left(p_{\lambda}\right)}{\tau_{k}}
-\frac{\beta}{\tau_{k}}\sum\limits_{\forall r : \left\{s,r\right\}\in C}\delta\left(\lambda,\omega_{r}\right)\right)}
}
\end{equation}

2.1. $\widehat{\omega}^{k}$ is drawn from distribution in Equation (NUMBER NEEDED).

2.2. $\widehat{\Theta}^{k}$ is drawn from distribution in Equation (NUMBER NEEDED).

2.3. $\widehat{p}^{k}$ is drawn from distribution in Equation (NUMBER NEEDED).

2.4. Sampling MRF hyperparameter $\widehat{\beta}^{k}$ from Equation (NUMBER NEEDED).

2.5. $\widehat{L}^{k}$ is estimated using the reversible jump techniques from the section (SECTION NUMBER NEEDED)

3. GOTO to step 2 with $k=k+1$ and $T_{k+1}$ until $k\leq K$.

% The very first letter is a 2 line initial drop letter followed
% by the rest of the first word in caps.
% 
% form to use if the first word consists of a single letter:
% \PARstart{A}{demo} file is ....
% 
% form to use if you need the single drop letter followed by
% normal text (unknown if ever used by IEEE):
% \PARstart{A}{}demo file is ....
% 
% Some journals put the first two words in caps:
% \PARstart{T}{his demo} file is ....
% 
% Here we have the typical use of a "T" for an initial drop letter
% and "HIS" in caps to complete the first word.
%\PARstart{T}{his} demo file is intended to serve as a ``starter file"
%for IEEE journal papers produced under \LaTeX\ using IEEEtran.cls version
%1.6b and later.
% You must have at least 2 lines in the paragraph with the drop letter
% (should never be an issue)
% May all your publication endeavors be successful.

\hfill mds
 
\hfill \date{\today}

\subsection{Subsection Heading Here}
Subsection text here.

% needed in second column of first page if using \pubid
%\pubidadjcol

\subsubsection{Subsubsection Heading Here}
Subsubsection text here.

% Reminder: the "draftcls" or "draftclsnofoot", not "draft", class option
% should be used if it is desired that the figures are to be displayed while
% in draft mode.

% An example of a floating figure using the graphicx package.
% Note that \label must occur AFTER (or within) \caption.
% For figures, \caption should occur after the \includegraphics.
%
%\begin{figure}
%\centering
%\includegraphics[width=2.5in]{myfigure}
% where an .eps filename suffix will be assumed under latex, 
% and a .pdf suffix will be assumed for pdflatex
%\caption{Simulation Results}
%\label{fig_sim}
%\end{figure}


% An example of a double column floating figure using two subfigures.
% (The subfigure.sty package must be loaded for this to work.)
% The subfigure \label commands are set within each subfigure command, the
% \label for the overall fgure must come after \caption.
% \hfil must be used as a separator to get equal spacing
%
%\begin{figure*}
%\centerline{\subfigure[Case I]{\includegraphics[width=2.5in]{subfigcase1}
% where an .eps filename suffix will be assumed under latex, 
% and a .pdf suffix will be assumed for pdflatex
%\label{fig_first_case}}
%\hfil
%\subfigure[Case II]{\includegraphics[width=2.5in]{subfigcase2}
% where an .eps filename suffix will be assumed under latex, 
% and a .pdf suffix will be assumed for pdflatex
%\label{fig_second_case}}}
%\caption{Simulation results}
%\label{fig_sim}
%\end{figure*}



% An example of a floating table. Note that, for IEEE style tables, the 
% \caption command should come BEFORE the table. Table text will default to
% \footnotesize as IEEE normally uses this smaller font for tables.
% The \label must come after \caption as always.
%
%\begin{table}
%% increase table row spacing, adjust to taste
%\renewcommand{\arraystretch}{1.3}
%\caption{An Example of a Table}
%\label{table_example}
%\centering
%% Some packages, such as MDW tools, offer better commands for making tables
%% than the plain LaTeX2e tabular which is used here.
%\begin{tabular}{|c||c|}
%\hline
%One & Two\\
%\hline
%Three & Four\\
%\hline
%\end{tabular}
%\end{table}


\section{Conclusion}
The conclusion goes here.

% if have a single appendix:
%\appendix[Proof of the Zonklar Equations]
% or
%\appendix  % for no appendix heading
% do not use \section anymore after \appendix, only \section*
% is possibly needed

% use appendices with more than one appendix
% then use \section to start each appendix
% you must declare a \section before using any
% \subsection or using \label (\appendices by itself
% starts a section numbered zero.)
%
% Use this command to get the appendices' numbers in "A", "B" instead of the
% default capitalized Roman numerals ("I", "II", etc.).
% However, the capital letter form may result in awkward subsection numbers
% (such as "A-A"). Capitalized Roman numerals are the default.
%\useRomanappendicesfalse
%
\appendices
\section{Proof of the First Zonklar Equation}
Appendix one text goes here.

% you can choose not to have a title for an appendix
% if you want by leaving the argument blank
\section{}
Appendix two text goes here.

% use section* for acknowledgement
\section*{Acknowledgment}
% optional entry into table of contents (if used)
%\addcontentsline{toc}{section}{Acknowledgment}
The authors would like to thank...

% trigger a \newpage just before the given reference
% number - used to balance the columns on the last page
% adjust value as needed - may need to be readjusted if
% the document is modified later
%\IEEEtriggeratref{8}
% The "triggered" command can be changed if desired:
%\IEEEtriggercmd{\enlargethispage{-5in}}

% references section
% NOTE: BibTeX documentation can be easily obtained at:
% http://www.ctan.org/tex-archive/biblio/bibtex/contrib/doc/

% can use a bibliography generated by BibTeX as a .bbl file
% standard IEEE bibliography style from:
% http://www.ctan.org/tex-archive/macros/latex/contrib/supported/IEEEtran/bibtex
%\bibliographystyle{IEEEtran.bst}
% argument is your BibTeX string definitions and bibliography database(s)
%\bibliography{IEEEabrv,../bib/paper}
%
% <OR> manually copy in the resultant .bbl file
% set second argument of \begin to the number of references
% (used to reserve space for the reference number labels box)
\begin{thebibliography}{1}

\bibitem{Kato99}
Z.~Kato \emph{Bayesian color image segmentation using reversible jump Markov chain Monte Carlo}.\hskip 1em plus
  0.5em minus 0.4em\relax Probability, Networks and Algorithms, February, 28, 1999. CWI, Amsterdam.

\bibitem{BesagICM}
J.~Besag \emph{On the statistical analysis of dirty pictures}.\hskip 1em plus
  0.5em minus 0.4em\relax Jl.~Roy.~Statist.~Soc.,~ser.~B,~1986.

\bibitem{Metropolis:SA}
N.~Metropolis, A.~Rosenbluth, M.~Rosenbluth, A.~Teller, and E.~Teller \emph{Equation of state calculation by fast computing machines}.\hskip 1em plus
  0.5em minus 0.4em\relax J.~of Chem.~Physics, Vol.~21, pp 1087-1092, 1953.

\bibitem{Hasting}
W.~K.~Hasting \emph{Monte carlo sampling methods using Markov chains and their application}.\hskip 1em plus 0.5em minus 0.4em\relax Biometrika, vol.~57, pp.~1701-1762,~1994.

\bibitem{Green}
P.~J.~Green \emph{Reversible jump Markov chain Monte Carlo computation and Bayesian model determination}.\hskip 1em plus 0.5em minus 0.4em\relax Biometrika, vol.~82, no.~4, pp.~711-731,~1995.

\end{thebibliography}

% biography section
% 
% If you have an EPS/PDF photo (graphicx package needed) extra braces are
% needed around the contents of the optional argument to biography to prevent
% the LaTeX parser from getting confused when it sees the complicated
% \includegraphics command within an optional argument. (You could create
% your own custom macro containing the \includegraphics command to make things
% simpler here.)
%\begin{biography}[{\includegraphics[width=1in,height=1.25in,clip,keepaspectratio]{mshell}}]{Michael Shell}
% where an .eps filename suffix will be assumed under latex, and a .pdf suffix
% will be assumed for pdflatex; or if you just want to reserve a space for
% a photo:

%\begin{biography}{Michael Shell}
%Biography text here.
%\end{biography}

% if you will not have a photo at all:
%\begin{biographynophoto}{John Doe}
%Biography text here.
%\end{biographynophoto}

% insert where needed to balance the two columns on the last page
%\newpage

%\begin{biographynophoto}{Jane Doe}
%Biography text here.
%\end{biographynophoto}

% You can push biographies down or up by placing
% a \vfill before or after them. The appropriate
% use of \vfill depends on what kind of text is
% on the last page and whether or not the columns
% are being equalized.

%\vfill

% Can be used to pull up biographies so that the bottom of the last one
% is flush with the other column.
%\enlargethispage{-5in}

% that's all folks
\end{document}